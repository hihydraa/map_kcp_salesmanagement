<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KC Fuel – Sales & Leads Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }
    .leaflet-tooltip.my { background:#111827; color:#fff; border:none; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.2); padding:6px 8px; }
    .badge { padding:2px 8px; border-radius:999px; font-size:12px; font-weight:600; }
    .kv td:first-child { color:#6b7280; padding-right:.5rem; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="panel" class="fixed z-[999] top-3 left-3 w-[360px] max-w-[92vw] bg-white/95 backdrop-blur border border-gray-200 rounded-2xl shadow-xl">
    <div class="p-4 border-b">
      <h1 class="text-xl font-bold text-gray-900">KC Fuel – Sales & Leads Map</h1>
      <p class="text-xs text-gray-500">แผนที่บริหารลูกค้าปัจจุบัน & ลูกค้ามุ่งหวัง (Google Sheets → แผนที่แบบเรียลไทม์)</p>
    </div>
    <div class="p-4 flex flex-col gap-3">
      <div class="grid grid-cols-2 gap-2">
        <label class="text-xs text-gray-600">สาขา (Branch)
          <select id="branchFilter" class="w-full mt-1 rounded-lg border-gray-300 text-sm"></select>
        </label>
        <label class="text-xs text-gray-600">ผู้จัดการ (Manager)
          <select id="managerFilter" class="w-full mt-1 rounded-lg border-gray-300 text-sm"></select>
        </label>
        <label class="text-xs text-gray-600">รถมิเตอร์ (Truck)
          <select id="truckFilter" class="w-full mt-1 rounded-lg border-gray-300 text-sm"></select>
        </label>
        <label class="text-xs text-gray-600">สถานะลูกค้า
          <select id="statusFilter" class="w-full mt-1 rounded-lg border-gray-300 text-sm">
            <option value="">ทั้งหมด</option>
            <option value="active">active</option>
            <option value="risky to lost">risky to lost</option>
            <option value="lost customer">lost customer</option>
          </select>
        </label>
      </div>
      <div class="flex items-center gap-3">
        <label class="inline-flex items-center gap-2 text-sm">
          <input id="toggleLeads" type="checkbox" class="rounded" checked /> แสดง Leads
        </label>
        <label class="inline-flex items-center gap-2 text-sm">
          <input id="toggleNearest" type="checkbox" class="rounded" checked /> คำนวณรถที่ใกล้สุดให้ Leads
        </label>
      </div>
      <div class="flex gap-2">
        <button id="btnRefresh" class="px-3 py-2 text-sm rounded-lg bg-gray-900 text-white">รีเฟรชข้อมูล</button>
        <button id="btnReset" class="px-3 py-2 text-sm rounded-lg border">ล้างตัวกรอง</button>
      </div>
      <div class="rounded-xl border bg-white p-3">
        <div class="text-xs text-gray-500 mb-1">สรุป</div>
        <div id="summary" class="text-sm grid grid-cols-2 gap-x-3 gap-y-1">
          <div>Customers:</div><div id="sumCustomers" class="font-semibold">-</div>
          <div>Leads:</div><div id="sumLeads" class="font-semibold">-</div>
          <div>Active:</div><div id="sumActive" class="font-semibold">-</div>
          <div>Risky:</div><div id="sumRisky" class="font-semibold">-</div>
          <div>Lost:</div><div id="sumLost" class="font-semibold">-</div>
        </div>
        <div id="errorBox" class="text-xs text-red-600 mt-2 hidden"></div>
      </div>
      <div class="text-xs text-gray-500">ตั้งค่าในชีท: <span class="font-mono">Settings</span></div>
    </div>
  </div>
  <div id="map"></div>

  <script>
    // -------- CONFIG --------
    const SHEET_ID = "1KicClhZHtMr9bBmwLv31zvb0021SRUcGr2eRRagsO6c";
    const SHEETS = { customers: "Customers", leads: "leads", trucks: "Trucks", settings: "Settings" };

    // -------- UTIL --------
    function showError(msg){ console.error(msg); const box=document.getElementById('errorBox'); box.textContent=msg; box.classList.remove('hidden'); }

    // Read sheet with: formatted values first (c.f), then raw (c.v)
    async function fetchSheet(sheetName) {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&tq=`;
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      if(!text.includes('google.visualization')) throw new Error(`โหลดชีท "${sheetName}" ไม่สำเร็จ\n${text.slice(0,160)}`);
      const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
      const colsRaw = json.table.cols.map(c => (c.label || c.id || '').toString());
      const rowsRaw = json.table.rows.map(r => (r.c||[]).map(c => c ? (c.f ?? c.v ?? "") : ""));

      // Normalize headers -> trim, lower, spaces => _
      const cols = colsRaw.map(h => h.trim().toLowerCase().replace(/\s+/g,'_'));
      // Build records
      return rowsRaw.map(r => {
        const o = {};
        r.forEach((v,i)=>{ o[cols[i] || `col${i+1}`] = v; });
        return o;
      });
    }

    // Helpers
    const normHex = c => !c ? "" : (String(c).trim().startsWith('#')?String(c).trim():'#'+String(c).trim());
    const gmapsUrl = (lat,lng) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(lat+","+lng)}`;
    const uniqueSorted = arr => [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b,'th'));
    const haversineKm=(a,b,c,d)=>{const R=6371,toRad=x=>x*Math.PI/180;const dLat=toRad(c-a),dLon=toRad(d-b);const h=Math.sin(dLat/2)**2+Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLon/2)**2;return 2*R*Math.asin(Math.sqrt(h));};

    // Try multiple keys: returns first non-empty
    function get(obj, keys){
      for(const k of keys){
        if(obj[k]!==undefined && obj[k]!==null && obj[k]!=="") return obj[k];
      }
      return "";
    }

    // Label map (แสดงชื่อสวย ๆ)
    const LBL = {
      customer_id:'customer_id',
      customer_name:'customer_name',
      lastest_sales:'lastest_sales',
      latest_sales:'lastest_sales',
      last_sale:'lastest_sales',
      status:'status',
      branch:'branch',
      truck_id:'truck_id',
      manager_incharge:'manager_incharge',
      notes:'notes',
      leads_name:'leads_name',
      province:'province',
      district:'district',
      nearest_truck_id:'nearest_truck_id',
      saler:'saler'
    };

    // Build table rows with chosen fields (hide lat/long)
    function buildRowsHtml(obj, fields){
      const rows=[];
      fields.forEach(f=>{
        let val="";
        if(f==='lastest_sales'){
          val = get(obj, ['lastest_sales','latest_sales','last_sale']); // ลองหลายรูปแบบ
        }else{
          val = obj[f];
        }
        if(val!==undefined && val!==null && val!==""){
          rows.push(`<tr><td>${LBL[f]||f}</td><td class="font-semibold">${val}</td></tr>`);
        }
      });
      return rows.join('');
    }

    // Tooltip/popup
    function tooltipHtml(obj,type,colorBadge){
      const fields = (type==='customer')
        ? ['customer_id','customer_name','lastest_sales','status','branch','truck_id','manager_incharge','notes']
        : ['leads_name','status','province','district','nearest_truck_id','saler','branch','notes'];
      const rows = buildRowsHtml(obj, fields);
      const badge = `<span class="badge" style="background:${colorBadge};color:white">${get(obj,['status','_statusnorm'])}</span>`;
      return `<div class="text-sm">
        <div class="mb-1 font-bold">${obj.customer_name||obj.leads_name||obj.truck_id} ${badge}</div>
        <table class="text-xs kv">${rows}</table>
      </div>`;
    }
    function popupHtml(obj,type,lat,lng){
      const fields = (type==='customer')
        ? ['customer_id','customer_name','lastest_sales','status','branch','truck_id','manager_incharge','notes']
        : ['leads_name','status','province','district','nearest_truck_id','saler','branch','notes'];
      const rows = buildRowsHtml(obj, fields);
      const gmBtn = (isFinite(lat)&&isFinite(lng))
        ? `<a href="${gmapsUrl(lat,lng)}" target="_blank" rel="noopener" class="mt-2 inline-block text-xs font-semibold text-blue-600 underline">เปิดใน Google Maps</a>`:'';
      return `<div class="text-sm">
        <div class="mb-1 font-bold">${obj.customer_name||obj.leads_name||obj.truck_id}</div>
        <table class="text-xs kv">${rows}</table>
        ${gmBtn}
      </div>`;
    }

    // --- Map layers
    const map = L.map('map'); // default closePopupOnClick = true
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    const layerCustomers=L.layerGroup().addTo(map),layerLeads=L.layerGroup().addTo(map),layerTrucks=L.layerGroup().addTo(map),layerLines=L.layerGroup().addTo(map);

    let data={customers:[],leads:[],trucks:[],settings:[]};
    let truckColorMap={};
    const getTruckColor = id => !id ? "" : (truckColorMap[String(id).trim().toLowerCase()]||"#16a34a");

    function passFilters(item){
      const b=branchFilter.value, m=managerFilter.value, t=truckFilter.value, s=statusFilter.value;
      if(b && (item.branch||'')!==b) return false;
      if(m && (item.manager_incharge||'')!==m) return false;
      if(t && (item.truck_id||item.nearest_truck_id||'')!==t) return false;
      if(s && (item.status||item._statusnorm||'')!==s) return false;
      return true;
    }
    function setSummary({customers, leads}){
      sumCustomers.textContent = customers.length;
      sumLeads.textContent = leads.length;
      sumActive.textContent = customers.filter(c => (c.status||c._statusnorm||'')==='active').length;
      sumRisky.textContent  = customers.filter(c => (c.status||c._statusnorm||'')==='risky to lost').length;
      sumLost.textContent   = customers.filter(c => (c.status||c._statusnorm||'')==='lost customer').length;
    }

    function render(){
      layerCustomers.clearLayers();layerLeads.clearLayers();layerTrucks.clearLayers();layerLines.clearLayers();

      // Trucks
      data.trucks.forEach(t=>{
        const lat = +get(t,['latitude','lat','lattitude']);
        const lng = +get(t,['longitude','lng','longtitude','lon']);
        if(!isFinite(lat)||!isFinite(lng)) return;
        const col=normHex(get(t,['color']))||'#111827';
        L.circleMarker([lat,lng],{radius:7,color:col,weight:2,fillColor:'#fff',fillOpacity:1})
          .bindTooltip(`<div class="text-sm font-bold">${t.truck_id||t.truck||''}</div>`,{className:'my',sticky:true})
          .addTo(layerTrucks);
      });

      const cust = data.customers.filter(passFilters);
      const leads = (toggleLeads.checked? data.leads: []).filter(passFilters);

      // Customers
      cust.forEach(c=>{
        const lat = +get(c,['latitude','lat','lattitude']);
        const lng = +get(c,['longitude','lng','longtitude','lon']);
        if(!isFinite(lat)||!isFinite(lng)) return;
        const col=getTruckColor(c.truck_id);
        const tip = tooltipHtml(c,'customer',col);
        const m = L.circleMarker([lat,lng],{radius:6,color:col,weight:2,fillColor:col,fillOpacity:.2})
          .bindTooltip(tip,{className:'my',sticky:true})
          .addTo(layerCustomers);
        m.on('click',()=>{ m.bindPopup(popupHtml(c,'customer',lat,lng), {autoClose:true, closeOnClick:true, className:'my'}).openPopup(); });
      });

      // Leads
      const wantNearest = toggleNearest.checked;
      leads.forEach(l=>{
        const lat = +get(l,['latitude','lat','lattitude']);
        const lng = +get(l,['longitude','lng','longtitude','lon']);
        if(!isFinite(lat)||!isFinite(lng)) return;
        const tip = tooltipHtml(l,'lead','#2563eb');
        const mk = L.circleMarker([lat,lng],{radius:6,color:'#2563eb',weight:2,fillColor:'#2563eb',fillOpacity:.2})
          .bindTooltip(tip,{className:'my',sticky:true})
          .addTo(layerLeads);
        mk.on('click',()=>{ mk.bindPopup(popupHtml(l,'lead',lat,lng), {autoClose:true, closeOnClick:true, className:'my'}).openPopup(); });

        if(wantNearest){
          let best={d:Infinity,t:null};
          data.trucks.forEach(t=>{
            const tlat=+get(t,['latitude','lat','lattitude']);
            const tlng=+get(t,['longitude','lng','longtitude','lon']);
            if(!isFinite(tlat)||!isFinite(tlng)) return;
            const d=haversineKm(lat,lng,tlat,tlng);
            if(d<best.d) best={d,t};
          });
          if(best.t){
            const tlat=+get(best.t,['latitude','lat','lattitude']);
            const tlng=+get(best.t,['longitude','lng','longtitude','lon']);
            L.polyline([[lat,lng],[tlat,tlng]],{color:'#64748b',weight:1.5,dashArray:'4 4'}).addTo(layerLines);
          }
        }
      });

      // Fit view & summary
      const all=[]; layerCustomers.eachLayer(l=>all.push(l.getLatLng())); layerLeads.eachLayer(l=>all.push(l.getLatLng())); layerTrucks.eachLayer(l=>all.push(l.getLatLng()));
      if(all.length) map.fitBounds(L.latLngBounds(all),{padding:[60,60]});
      setSummary({customers:cust,leads});
    }

    async function loadAndRender(){
      try{
        errorBox.classList.add('hidden');
        const [settings,customers,leads,trucks] = await Promise.all([
          fetchSheet(SHEETS.settings), fetchSheet(SHEETS.customers), fetchSheet(SHEETS.leads), fetchSheet(SHEETS.trucks)
        ]);

        // Save
        data={settings,customers,leads,trucks};

        // Center (fallback ถ้าไม่ตั้งค่า)
        const findVal = key => {
          const up = key.toUpperCase();
          const rec = settings.find(r => Object.keys(r).some(k => k.toUpperCase()==='KEY' || k.toUpperCase()==='SETTING') && (r.key||r.setting||'').toString().toUpperCase()===up);
          return rec ? (rec.value ?? rec.val ?? rec.setting_value ?? '') : '';
        };
        const cLat = parseFloat(findVal('CENTER_LAT')||16.43), cLng=parseFloat(findVal('CENTER_LNG')||103.49), zoom=parseInt(findVal('ZOOM')||9);
        map.setView([cLat,cLng], zoom);

        // Truck colors map
        truckColorMap={};
        trucks.forEach(t=>{
          const id=(t.truck_id||t.truck||'').toString().trim().toLowerCase();
          const col=normHex(t.color||'');
          if(id && /^#?[0-9A-Fa-f]{6}$/.test(col.replace('#',''))) truckColorMap[id]=col.startsWith('#')?col:'#'+col;
        });

        // Build filters
        const setOpts=(el,opts)=>{ el.innerHTML=''; el.append(new Option('ทั้งหมด','')); opts.forEach(o=>el.append(new Option(o,o))); };
        setOpts(branchFilter, uniqueSorted([ ...customers.map(c=>c.branch), ...leads.map(l=>l.branch) ]));
        setOpts(managerFilter, uniqueSorted([ ...customers.map(c=>c.manager_incharge), ...trucks.map(t=>t.manager_incharge) ]));
        setOpts(truckFilter, uniqueSorted(trucks.map(t=>t.truck_id||t.truck)));

        render();
      }catch(err){ showError(err.message||String(err)); }
    }

    // UI
    btnRefresh.onclick = ()=>loadAndRender(true);
    btnReset.onclick = ()=>{ [branchFilter,managerFilter,truckFilter,statusFilter].forEach(el=>el.value=""); render(); };
    [branchFilter,managerFilter,truckFilter,statusFilter,toggleLeads,toggleNearest].forEach(el=> el.addEventListener('change',render));

    loadAndRender();
    setInterval(loadAndRender,300000);
  </script>
</body>
</html>
