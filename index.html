<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KC Fuel – Sales & Leads Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }
    .leaflet-tooltip.my { background:#111827; color:#fff; border:none; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.2); padding:6px 8px; }
    .badge { padding:2px 8px; border-radius:999px; font-size:12px; font-weight:600; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="panel" class="fixed z-[999] top-3 left-3 w-[360px] max-w-[92vw] bg-white/95 backdrop-blur border border-gray-200 rounded-2xl shadow-xl">
    <div class="p-4 border-b">
      <h1 class="text-xl font-bold text-gray-900">KC Fuel – Sales & Leads Map</h1>
      <p class="text-xs text-gray-500">แผนที่บริหารลูกค้าปัจจุบัน & ลูกค้ามุ่งหวัง (ดึงข้อมูลแบบเรียลไทม์จาก Google Sheets)</p>
    </div>
    <div class="p-4 flex flex-col gap-3">
      <div class="grid grid-cols-2 gap-2">
        <label class="text-xs text-gray-600">สาขา (Branch)
          <select id="branchFilter" class="w-full mt-1 rounded-lg border-gray-300 text-sm"></select>
        </label>
        <label class="text-xs text-gray-600">ผู้จัดการ (Manager)
          <select id="managerFilter" class="w-full mt-1 rounded-lg border-gray-300 text-sm"></select>
        </label>
        <label class="text-xs text-gray-600">รถมิเตอร์ (Truck)
          <select id="truckFilter" class="w-full mt-1 rounded-lg border-gray-300 text-sm"></select>
        </label>
        <label class="text-xs text-gray-600">สถานะลูกค้า
          <select id="statusFilter" class="w-full mt-1 rounded-lg border-gray-300 text-sm">
            <option value="">ทั้งหมด</option>
            <option value="active">active</option>
            <option value="risky to lost">risky to lost</option>
            <option value="lost customer">lost customer</option>
          </select>
        </label>
      </div>
      <div class="flex items-center gap-3">
        <label class="inline-flex items-center gap-2 text-sm">
          <input id="toggleLeads" type="checkbox" class="rounded" checked /> แสดง Leads
        </label>
        <label class="inline-flex items-center gap-2 text-sm">
          <input id="toggleNearest" type="checkbox" class="rounded" checked /> คำนวณรถที่ใกล้สุดให้ Leads
        </label>
      </div>
      <div class="flex gap-2">
        <button id="btnRefresh" class="px-3 py-2 text-sm rounded-lg bg-gray-900 text-white">รีเฟรชข้อมูล</button>
        <button id="btnReset" class="px-3 py-2 text-sm rounded-lg border">ล้างตัวกรอง</button>
      </div>
      <div class="rounded-xl border bg-white p-3">
        <div class="text-xs text-gray-500 mb-1">สรุป</div>
        <div id="summary" class="text-sm grid grid-cols-2 gap-x-3 gap-y-1">
          <div>Customers:</div><div id="sumCustomers" class="font-semibold">-</div>
          <div>Leads:</div><div id="sumLeads" class="font-semibold">-</div>
          <div>Active:</div><div id="sumActive" class="font-semibold">-</div>
          <div>Risky:</div><div id="sumRisky" class="font-semibold">-</div>
          <div>Lost:</div><div id="sumLost" class="font-semibold">-</div>
        </div>
      </div>
      <div class="text-xs text-gray-500">ตั้งค่าในชีท: <span class="font-mono">Settings</span></div>
    </div>
  </div>
  <div id="map"></div>

  <script>
    const SHEET_ID = "1KicClhZHtMr9bBmwLv31zvb0021SRUcGr2eRRagsO6c";
    const SHEETS = { customers: "Customers", leads: "leads", trucks: "Trucks", settings: "Settings", sales: "lastest_sales" };

    async function fetchSheet(sheetName) {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&tq=`;
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
      const cols = json.table.cols.map(c => c.label || c.id);
      const rows = json.table.rows.map(r => (r.c||[]).map(c => c ? c.v : ""));
      return rows.map(r => Object.fromEntries(r.map((v,i) => [cols[i] || `col${i+1}`, v])));
    }

    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    const layerCustomers=L.layerGroup().addTo(map),layerLeads=L.layerGroup().addTo(map),layerTrucks=L.layerGroup().addTo(map),layerLines=L.layerGroup().addTo(map);

    let data={customers:[],leads:[],trucks:[],settings:[],sales:[]};
    let thresholds={risk:30,lost:60};
    let truckColorMap={};
    function normHex(c){if(!c)return"";c=String(c).trim();return c.startsWith('#')?c:'#'+c}
    function getTruckColor(id){if(!id)return"";return truckColorMap[String(id).trim().toLowerCase()]||""}

    function normStatusByDate(lastDate){if(!lastDate)return 'lost customer';const d=new Date(lastDate);if(isNaN(d))return 'lost customer';const diff=(Date.now()-d.getTime())/86400000;if(diff>thresholds.lost)return 'lost customer';if(diff>thresholds.risk)return'risky to lost';return'active'}

    function popHtml(obj,type){const rows=Object.entries(obj).filter(([k,v])=>!k.startsWith('_')&&v!="").map(([k,v])=>`<tr><td>${k}</td><td>${v}</td></tr>`).join('');const badge= type==='customer'?`<span class="badge" style="background:${getTruckColor(obj.truck_id)||'#16a34a'};color:white">${obj._statusNorm}</span>`:`<span class="badge" style="background:#2563eb;color:white">LEAD</span>`;return `<div>${obj.customer_name||obj.leads_name||obj.truck_id} ${badge}<table>${rows}</table></div>`}

    function render(){layerCustomers.clearLayers();layerLeads.clearLayers();layerTrucks.clearLayers();layerLines.clearLayers();data.trucks.forEach(t=>{if(t.latitude&&t.longitude){const col=normHex(t.color||'')||'#111827';L.circleMarker([+t.latitude,+t.longitude],{radius:7,color:col,weight:2,fillColor:'#fff',fillOpacity:1}).bindTooltip(popHtml(t,'truck')).addTo(layerTrucks)}});data.customers.forEach(c=>{if(c.latitude&&c.longitude){const col=getTruckColor(c.truck_id)||'#16a34a';L.circleMarker([+c.latitude,+c.longitude],{radius:6,color:col,weight:2,fillColor:col,fillOpacity:.2}).bindTooltip(popHtml(c,'customer')).addTo(layerCustomers)}});}

    async function loadAndRender(){const [settings,customers,leads,trucks,sales]=await Promise.all([fetchSheet(SHEETS.settings),fetchSheet(SHEETS.customers),fetchSheet(SHEETS.leads),fetchSheet(SHEETS.trucks),fetchSheet(SHEETS.sales)]);data={settings,customers,leads,trucks,sales};thresholds={risk:30,lost:60};truckColorMap={};trucks.forEach(t=>{const id=(t.truck_id||'').toLowerCase();const col=normHex(t.color||'');if(id&&col)truckColorMap[id]=col});customers.forEach(c=>{const custSales=sales.filter(s=>s.customer_id==c.customer_id);if(custSales.length){const latest=custSales.map(s=>new Date(s.sale_date)).sort((a,b)=>b-a)[0];c.lastest_sales=latest.toISOString().slice(0,10);c._statusNorm=normStatusByDate(latest)}else{c._statusNorm='lost customer'}});map.setView([16.43,103.49],9);render()}

    loadAndRender();setInterval(loadAndRender,300000);
  </script>
</body>
</html>
