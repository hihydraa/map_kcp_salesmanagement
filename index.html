<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KC Fuel – Sales & Leads Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }
    .leaflet-tooltip.my { background:#111827; color:#fff; border:none; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.2); padding:6px 8px; }
    .badge { padding:2px 8px; border-radius:999px; font-size:12px; font-weight:600; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="panel" class="fixed z-[999] top-3 left-3 w-[360px] max-w-[92vw] bg-white/95 backdrop-blur border border-gray-200 rounded-2xl shadow-xl">
    <div class="p-4 border-b">
      <h1 class="text-xl font-bold text-gray-900">KC Fuel – Sales & Leads Map</h1>
      <p class="text-xs text-gray-500">แผนที่บริหารลูกค้าปัจจุบัน & ลูกค้ามุ่งหวัง (Google Sheets → แผนที่แบบเรียลไทม์)</p>
    </div>
    <div class="p-4 flex flex-col gap-3">
      <div class="grid grid-cols-2 gap-2">
        <label class="text-xs text-gray-600">สาขา (Branch)
          <select id="branchFilter" class="w-full mt-1 rounded-lg border-gray-300 text-sm"></select>
        </label>
        <label class="text-xs text-gray-600">ผู้จัดการ (Manager)
          <select id="managerFilter" class="w-full mt-1 rounded-lg border-gray-300 text-sm"></select>
        </label>
        <label class="text-xs text-gray-600">รถมิเตอร์ (Truck)
          <select id="truckFilter" class="w-full mt-1 rounded-lg border-gray-300 text-sm"></select>
        </label>
        <label class="text-xs text-gray-600">สถานะลูกค้า
          <select id="statusFilter" class="w-full mt-1 rounded-lg border-gray-300 text-sm">
            <option value="">ทั้งหมด</option>
            <option value="active">active</option>
            <option value="risky to lost">risky to lost</option>
            <option value="lost customer">lost customer</option>
          </select>
        </label>
      </div>
      <div class="flex items-center gap-3">
        <label class="inline-flex items-center gap-2 text-sm">
          <input id="toggleLeads" type="checkbox" class="rounded" checked /> แสดง Leads
        </label>
        <label class="inline-flex items-center gap-2 text-sm">
          <input id="toggleNearest" type="checkbox" class="rounded" checked /> คำนวณรถที่ใกล้สุดให้ Leads
        </label>
      </div>
      <div class="flex gap-2">
        <button id="btnRefresh" class="px-3 py-2 text-sm rounded-lg bg-gray-900 text-white">รีเฟรชข้อมูล</button>
        <button id="btnReset" class="px-3 py-2 text-sm rounded-lg border">ล้างตัวกรอง</button>
      </div>
      <div class="rounded-xl border bg-white p-3">
        <div class="text-xs text-gray-500 mb-1">สรุป</div>
        <div id="summary" class="text-sm grid grid-cols-2 gap-x-3 gap-y-1">
          <div>Customers:</div><div id="sumCustomers" class="font-semibold">-</div>
          <div>Leads:</div><div id="sumLeads" class="font-semibold">-</div>
          <div>Active:</div><div id="sumActive" class="font-semibold">-</div>
          <div>Risky:</div><div id="sumRisky" class="font-semibold">-</div>
          <div>Lost:</div><div id="sumLost" class="font-semibold">-</div>
        </div>
        <div id="errorBox" class="text-xs text-red-600 mt-2 hidden"></div>
      </div>
      <div class="text-xs text-gray-500">ตั้งค่าในชีท: <span class="font-mono">Settings</span></div>
    </div>
  </div>
  <div id="map"></div>

  <script>
    const SHEET_ID = "1KicClhZHtMr9bBmwLv31zvb0021SRUcGr2eRRagsO6c";
    const SHEETS = { customers: "Customers", leads: "leads", trucks: "Trucks", settings: "Settings", sales: "lastest_sales" };

    function showError(msg){
      console.error(msg);
      const box = document.getElementById('errorBox');
      box.textContent = msg;
      box.classList.remove('hidden');
    }

    async function fetchSheet(sheetName) {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&tq=`;
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      if(!text.includes('google.visualization')){
        throw new Error(`โหลดชีท "${sheetName}" ไม่สำเร็จ (อาจเป็นสิทธิ์การเข้าถึงหรือชื่อแท็บไม่ตรง)\nResponse preview: ${text.slice(0,120)}`);
      }
      const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
      const cols = json.table.cols.map(c => c.label || c.id);
      const rows = json.table.rows.map(r => (r.c||[]).map(c => c ? c.v : ""));
      return rows.map(r => Object.fromEntries(r.map((v,i) => [cols[i] || `col${i+1}`, v])));
    }

    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    const layerCustomers=L.layerGroup().addTo(map),layerLeads=L.layerGroup().addTo(map),layerTrucks=L.layerGroup().addTo(map),layerLines=L.layerGroup().addTo(map);

    let data={customers:[],leads:[],trucks:[],settings:[],sales:[]};
    let thresholds={risk:30,lost:60};
    let truckColorMap={};
    function normHex(c){if(!c)return"";c=String(c).trim();return c.startsWith('#')?c:'#'+c}
    function getTruckColor(id){if(!id)return"";return truckColorMap[String(id).trim().toLowerCase()]||""}

    // Parse date in formats like "05/09/2025 8:50" (DD/MM/YYYY HH:mm) or ISO
    function parseSaleDate(s){
      if(!s) return null;
      if(typeof s === 'number'){ // Google may send as serial date (days since 1899-12-30)
        const base = new Date(Date.UTC(1899,11,30));
        const ms = s*86400000; return new Date(base.getTime()+ms);
      }
      const str = String(s).trim();
      // Try ISO
      const dIso = new Date(str);
      if(!isNaN(dIso)) return dIso;
      // Try DD/MM/YYYY[ HH:MM]
      const m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2}))?$/);
      if(m){
        const dd=+m[1], mm=+m[2]-1, yyyy=+m[3];
        const HH=+(m[4]||'0'), MM=+(m[5]||'0');
        return new Date(yyyy,mm,dd,HH,MM);
      }
      return null;
    }

    function normStatusByDate(lastDate){
      const d = parseSaleDate(lastDate);
      if(!d) return 'lost customer';
      const diff = (Date.now()-d.getTime())/86400000;
      if(diff>thresholds.lost) return 'lost customer';
      if(diff>thresholds.risk) return 'risky to lost';
      return 'active';
    }

    function popHtml(obj,type){
      const rows=Object.entries(obj).filter(([k,v])=>!k.startsWith('_')&&v!==""&&v!=null).map(([k,v])=>`<tr><td class="pr-2 text-gray-500">${k}</td><td class="font-semibold">${v}</td></tr>`).join('');
      const badge= type==='customer'?`<span class="badge" style="background:${getTruckColor(obj.truck_id)||'#16a34a'};color:white">${obj._statusNorm}</span>`:`<span class="badge" style="background:#2563eb;color:white">LEAD</span>`;
      return `<div class="text-sm"><div class="mb-1 font-bold">${obj.customer_name||obj.leads_name||obj.truck_id} ${badge}</div><table class="text-xs">${rows}</table></div>`;
    }

    function setSummary({customers, leads}){
      const sumCustomers = customers.length;
      const sumLeads = leads.length;
      const active = customers.filter(c => (c._statusNorm||'')==='active').length;
      const risky = customers.filter(c => (c._statusNorm||'')==='risky to lost').length;
      const lost  = customers.filter(c => (c._statusNorm||'')==='lost customer').length;
      document.getElementById('sumCustomers').textContent = sumCustomers;
      document.getElementById('sumLeads').textContent = sumLeads;
      document.getElementById('sumActive').textContent = active;
      document.getElementById('sumRisky').textContent = risky;
      document.getElementById('sumLost').textContent = lost;
    }

    function render(){
      layerCustomers.clearLayers();layerLeads.clearLayers();layerTrucks.clearLayers();layerLines.clearLayers();
      // Trucks
      data.trucks.forEach(t=>{const lat=+ (t.latitude||t.lat||t.lattitude); const lng=+ (t.longitude||t.lng||t.longtitude||t.lon); if(!isFinite(lat)||!isFinite(lng)) return; const col=normHex(t.color||'')||'#111827'; L.circleMarker([lat,lng],{radius:7,color:col,weight:2,fillColor:'#fff',fillOpacity:1}).bindTooltip(popHtml(t,'truck'),{className:'my',sticky:true}).addTo(layerTrucks)});
      // Customers
      const cust = data.customers;
      cust.forEach(c=>{const lat=+ (c.latitude||c.lat||c.lattitude); const lng=+ (c.longitude||c.lng||c.longtitude||c.lon); if(!isFinite(lat)||!isFinite(lng)) return; const col=getTruckColor(c.truck_id)||'#16a34a'; L.circleMarker([lat,lng],{radius:6,color:col,weight:2,fillColor:col,fillOpacity:.2}).bindTooltip(popHtml(c,'customer'),{className:'my',sticky:true}).addTo(layerCustomers)});
      // Fit
      const all=[]; layerCustomers.eachLayer(l=>all.push(l.getLatLng())); layerTrucks.eachLayer(l=>all.push(l.getLatLng())); if(all.length){ map.fitBounds(L.latLngBounds(all),{padding:[60,60]}); }
      setSummary({customers:cust,leads:data.leads});
    }

    async function loadAndRender(){
      try{
        document.getElementById('errorBox').classList.add('hidden');
        const [settings,customers,leads,trucks,sales] = await Promise.all([
          fetchSheet(SHEETS.settings), fetchSheet(SHEETS.customers), fetchSheet(SHEETS.leads), fetchSheet(SHEETS.trucks), fetchSheet(SHEETS.sales)
        ]);
        data={settings,customers,leads,trucks,sales};
        // thresholds + center
        const findVal = key => (settings.find(r => (r.key||r.Key||r.setting||'').toString().toUpperCase()===key) || {}).value;
        thresholds.risk = parseInt(findVal('THRESHOLD_RISK_DAYS')||30);
        thresholds.lost = parseInt(findVal('THRESHOLD_LOST_DAYS')||60);
        const cLat = parseFloat(findVal('CENTER_LAT')||16.43), cLng=parseFloat(findVal('CENTER_LNG')||103.49), zoom=parseInt(findVal('ZOOM')||9);
        map.setView([cLat,cLng], zoom);
        // truck color map
        truckColorMap={}; trucks.forEach(t=>{const id=(t.truck_id||'').toString().trim().toLowerCase(); const col=normHex(t.color||''); if(id&&/^#?[0-9A-Fa-f]{6}$/.test(col.replace('#',''))) truckColorMap[id]=col.startsWith('#')?col:'#'+col;});
        // enrich customers with latest sales & status
        const salesByCust = sales.reduce((acc,row)=>{const id=row.customer_id; (acc[id]=acc[id]||[]).push(row); return acc;},{});
        data.customers = customers.map(c=>{const arr=salesByCust[c.customer_id]||[]; let latest=null; if(arr.length){ latest = arr.map(r=>parseSaleDate(r.sale_date)).filter(Boolean).sort((a,b)=>b-a)[0]; }
          const lastStr = latest? latest.toISOString().slice(0,10): '';
          return {...c, lastest_sales: c.lastest_sales || lastStr, _statusNorm: normStatusByDate(latest||c.lastest_sales)};
        });
        render();
      }catch(err){
        showError(err.message || String(err));
      }
    }

    document.getElementById('btnRefresh').onclick = ()=>loadAndRender(true);
    document.getElementById('btnReset').onclick = ()=>{ document.getElementById('branchFilter').value=''; document.getElementById('managerFilter').value=''; document.getElementById('truckFilter').value=''; document.getElementById('statusFilter').value=''; render(); };

    loadAndRender();
    setInterval(loadAndRender,300000);
  </script>
</body>
</html>
