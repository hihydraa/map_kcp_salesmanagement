<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KCP Map For Sales Management (Active Customer & Leads)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }
    .leaflet-tooltip.my { background:#111827; color:#fff; border:none; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.2); padding:6px 8px; }
    .badge { padding:2px 8px; border-radius:999px; font-size:12px; font-weight:600; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="panel" class="fixed z-[999] top-3 left-3 w-[360px] max-w-[92vw] bg-white/95 backdrop-blur border border-gray-200 rounded-2xl shadow-xl">
    <div class="p-4 border-b">
      <h1 class="text-xl font-bold text-gray-900">KCP Map For Sales Management (Real-Time)</h1>
      <p class="text-xs text-gray-500">แผนที่บริหารลูกค้าปัจจุบัน & ลูกค้ามุ่งหวัง (อัพเดตยอดขายถึงวันที่ 30 กันยายน)</p>
    </div>

    <div class="p-4 flex flex-col gap-3">
      <div class="grid grid-cols-2 gap-2">
        <label class="text-xs text-gray-600">สาขา (Branch)
          <select id="branchFilter" class="w-full mt-1 rounded-lg border-gray-300 text-sm"></select>
        </label>
        <label class="text-xs text-gray-600">ผู้จัดการมิเตอร์ (Manager)
          <select id="managerFilter" class="w-full mt-1 rounded-lg border-gray-300 text-sm"></select>
        </label>
        <label class="text-xs text-gray-600">รถมิเตอร์ (Truck)
          <select id="truckFilter" class="w-full mt-1 rounded-lg border-gray-300 text-sm"></select>
        </label>
        <label class="text-xs text-gray-600">สถานะลูกค้า
          <select id="statusFilter" class="w-full mt-1 rounded-lg border-gray-300 text-sm">
            <option value="">ทั้งหมด</option>
            <option value="ลูกค้า Active">ลูกค้า Active</option>
            <option value="เสี่ยงที่จะเป็นลูกค้าหาย">เสี่ยงที่จะเป็นลูกค้าหาย</option>
            <option value="ลูกค้าหาย">ลูกค้าหาย</option>
          </select>
        </label>
      </div>

      <!-- Toggles -->
      <div class="flex flex-col gap-2">
        <div class="flex items-center gap-3">
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="toggleLeads" type="checkbox" class="rounded" checked /> แสดง Leads
          </label>
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="toggleNearest" type="checkbox" class="rounded" checked /> คำนวณรถที่ใกล้สุดให้ Leads
          </label>
        </div>
        <div class="flex items-center gap-3">
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="toggleSinger" type="checkbox" class="rounded" checked /> แสดง Singer
          </label>
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="toggleNearestSinger" type="checkbox" class="rounded" checked /> คำนวณรถที่ใกล้สุดให้ Singer
          </label>
        </div>
      </div>

      <div class="flex gap-2 flex-wrap">
        <button id="btnRefresh" class="px-3 py-2 text-sm rounded-lg bg-gray-900 text-white">รีเฟรชข้อมูล</button>
        <button id="btnReset" class="px-3 py-2 text-sm rounded-lg border">ล้างตัวกรอง</button>
        <button id="btnExport" class="px-3 py-2 text-sm rounded-lg bg-emerald-600 text-white">ส่งออก (Excel)</button>
      </div>

      <div class="rounded-xl border bg-white p-3">
        <div class="text-xs text-gray-500 mb-1">สรุป</div>
        <div id="summary" class="text-sm grid grid-cols-2 gap-x-3 gap-y-1">
          <div>Customers:</div><div id="sumCustomers" class="font-semibold">-</div>
          <div>Leads:</div><div id="sumLeads" class="font-semibold">-</div>
          <div>Singer:</div><div id="sumSinger" class="font-semibold">-</div>
          <div>ลูกค้า Active:</div><div id="sumActive" class="font-semibold">-</div>
          <div>เสี่ยงที่จะเป็นลูกค้าหาย:</div><div id="sumRisky" class="font-semibold">-</div>
          <div>ลูกค้าหาย:</div><div id="sumLost" class="font-semibold">-</div>
        </div>
        <div id="errorBox" class="text-xs text-red-600 mt-2 hidden"></div>
      </div>

      <div class="text-xs text-gray-500">ตั้งค่าในชีท: <span class="font-mono">Settings</span></div>
    </div>
  </div>

  <div id="map"></div>

  <script>
    // -------- CONFIG --------
    const SHEET_ID = "1KicClhZHtMr9bBmwLv31zvb0021SRUcGr2eRRagsO6c";
    const SHEETS = { customers: "Customers", leads: "leads", singer: "singer", trucks: "Trucks", settings: "Settings" };

    // -------- UTIL --------
    function showError(msg){ console.error(msg); const box=document.getElementById('errorBox'); box.textContent=msg; box.classList.remove('hidden'); }

    async function fetchSheet(sheetName) {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&tq=`;
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      if(!text.includes('google.visualization')) throw new Error(`โหลดชีท "${sheetName}" ไม่สำเร็จ\n${text.slice(0,160)}`);
      const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
      const cols = json.table.cols.map(c => c.label || c.id);
      const rows = json.table.rows.map(r => (r.c||[]).map(c => c ? (c.f ?? c.v ?? "") : ""));
      return rows.map(r => Object.fromEntries(r.map((v,i) => [cols[i] || `col${i+1}`, v])));
    }

    // optional fetch (ไม่ทำให้ทั้งหน้าล้มเมื่อชีทหาย)
    async function fetchSheetOptional(name){
      try { return await fetchSheet(name); }
      catch(e){ console.warn(`[WARN] โหลดชีท ${name} ไม่สำเร็จ:`, e.message||e); showError(`คำเตือน: โหลดชีท "${name}" ไม่สำเร็จ (ตรวจชื่อแท็บ/สิทธิ์เข้าใช้งาน)`); return []; }
    }

    // ---------- Helpers ----------
    const normHex = (c) => { if (!c) return ""; const raw = String(c).trim().replace(/^#/, ""); return /^[0-9A-Fa-f]{6}$/.test(raw) ? "#" + raw.toUpperCase() : ""; };
    const normId = (id) => (id || "").toString().trim().toLowerCase();

    let truckColorMap = {};
    const getTruckColor = (id) => truckColorMap[normId(id)] || "";

    const uniqueSorted = (arr) => [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b,'th'));
    const gmapsUrl = (lat,lng) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(lat+","+lng)}`;
    const haversineKm=(a,b,c,d)=>{const R=6371,toRad=x=>x*Math.PI/180;const dLat=toRad(c-a),dLon=toRad(d-b);const h=Math.sin(dLat/2)**2+Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLon/2)**2;return 2*R*Math.asin(Math.sqrt(h));};

    // Pin สำหรับ Leads
    function makePinIcon(colorHex){
      const c = (colorHex||'#EF4444').replace('#','');
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="26" height="40" viewBox="0 0 26 40">
          <defs><filter id="shadow" x="-20%" y="-10%" width="140%" height="140%"><feGaussianBlur in="SourceAlpha" stdDeviation="1.5"/><feOffset dx="0" dy="1" result="o"/><feMerge><feMergeNode in="o"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
          <path filter="url(#shadow)" d="M13 0C6.373 0 1 5.373 1 12c0 8.25 12 27 12 27s12-18.75 12-27C25 5.373 19.627 0 13 0z" fill="#${c}" stroke="#7a7a7a" stroke-width="0.6"/>
          <circle cx="13" cy="12" r="5" fill="#fff"/>
        </svg>`;
      return L.icon({ iconUrl:'data:image/svg+xml;utf8,'+encodeURIComponent(svg), iconSize:[18,28], iconAnchor:[9,28], popupAnchor:[0,-24], tooltipAnchor:[0,-24] });
    }
    const leadPinColor = (statusText)=> String(statusText||'').trim()==='ปิดการขาย' ? '#308320' : '#EF4444';

    // Pin ตัวอักษร (Singer → “S”)
    function makeLetterPinIcon(colorHex, letter){
      const c = (colorHex||'#8B5CF6').replace('#','');
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="26" height="40" viewBox="0 0 26 40">
          <defs><filter id="shadow2" x="-20%" y="-10%" width="140%" height="140%"><feGaussianBlur in="SourceAlpha" stdDeviation="1.5"/><feOffset dx="0" dy="1" result="o"/><feMerge><feMergeNode in="o"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
          <path filter="url(#shadow2)" d="M13 0C6.373 0 1 5.373 1 12c0 8.25 12 27 12 27s12-18.75 12-27C25 5.373 19.627 0 13 0z" fill="#${c}" stroke="#6b6b6b" stroke-width="0.6"/>
          <circle cx="13" cy="12" r="6.2" fill="#fff"/>
          <text x="13" y="14" text-anchor="middle" font-size="9" font-weight="700" fill="#111">${(letter||'S').slice(0,1)}</text>
        </svg>`;
      return L.icon({ iconUrl:'data:image/svg+xml;utf8,'+encodeURIComponent(svg), iconSize:[20,30], iconAnchor:[10,30], popupAnchor:[0,-26], tooltipAnchor:[0,-26] });
    }

    // แปลงสถานะ EN->TH สำหรับ Customers
    function mapStatusTH(raw){
      if(raw==null) return "";
      const s = String(raw).trim(), sl = s.toLowerCase();
      if (sl==='active') return 'ลูกค้า Active';
      if (sl==='risky to lost') return 'เสี่ยงที่จะเป็นลูกค้าหาย';
      if (sl==='lost customer') return 'ลูกค้าหาย';
      if (s==='ลูกค้า active') return 'ลูกค้า Active';
      return s;
    }

    function buildRowsHtml(obj, fields){
      return fields.filter(k => obj[k] !== undefined && obj[k] !== null && obj[k] !== "")
                   .map(k => `<tr><td class="pr-2 text-gray-500">${k}</td><td class="font-semibold">${obj[k]}</td></tr>`).join('');
    }

    function tooltipHtml(obj,type){
      const fields = (type==='customer')
        ? ['customer_id','customer_name','lastest_sales','_statusTH','branch','truck_id','manager_incharge','notes']
        : ['leads_name','status','province','district','nearest_truck_id','saler','branch','notes'];
      const rows = buildRowsHtml(obj, fields);
      const badge = (type==='customer')
        ? `<span class="badge" style="background:${getTruckColor(obj.truck_id)||'#16a34a'};color:white">${obj._statusTH||''}</span>`
        : `<span class="badge" style="background:${type==='singer' ? '#8B5CF6' : '#2563eb'};color:white">${type==='singer'?'SINGER':'LEAD'}</span>`;
      return `<div class="text-sm"><div class="mb-1 font-bold">${obj.customer_name||obj.leads_name||obj.truck_id} ${badge}</div><table class="text-xs">${rows}</table></div>`;
    }

    function popupHtml(obj,type){
      const lat = parseFloat(obj.latitude||obj.lat||obj.lattitude);
      const lng = parseFloat(obj.longitude||obj.lng||obj.longtitude||obj.lon);
      const fields = (type==='customer')
        ? ['customer_id','customer_name','lastest_sales','_statusTH','branch','truck_id','manager_incharge','notes']
        : ['leads_name','status','province','district','nearest_truck_id','saler','branch','notes'];
      const rows = buildRowsHtml(obj, fields);
      const gmBtn = (isFinite(lat)&&isFinite(lng)) ? `<a href="${gmapsUrl(lat,lng)}" target="_blank" rel="noopener" class="mt-2 inline-block text-xs font-semibold text-blue-600 underline">เปิดใน Google Maps</a>` : '';
      return `<div class="text-sm"><div class="mb-1 font-bold">${obj.customer_name||obj.leads_name||obj.truck_id}</div><table class="text-xs">${rows}</table>${gmBtn}</div>`;
    }

    function passFilters(item){
      const b=branchFilter.value, m=managerFilter.value, t=truckFilter.value, s=statusFilter.value;
      if(b && (item.branch||'')!==b) return false;
      if(m && (item.manager_incharge||'')!==m) return false;
      if(t && (item.truck_id||item.nearest_truck_id||'')!==t) return false;
      if(s && (item._statusTH||'')!==s) return false; // ใช้กับ Customers เท่านั้น
      return true;
    }

    function setSummary({customers, leads, singer}){
      sumCustomers.textContent = customers.length;
      sumLeads.textContent     = leads.length;
      sumSinger.textContent    = singer.length;
      sumActive.textContent = customers.filter(c => (c._statusTH||'')==='ลูกค้า Active').length;
      sumRisky.textContent  = customers.filter(c => (c._statusTH||'')==='เสี่ยงที่จะเป็นลูกค้าหาย').length;
      sumLost.textContent   = customers.filter(c => (c._statusTH||'')==='ลูกค้าหาย').length;
    }

    // Map + Layers
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    const layerCustomers=L.layerGroup().addTo(map),
          layerLeads=L.layerGroup().addTo(map),
          layerSinger=L.layerGroup().addTo(map),
          layerTrucks=L.layerGroup().addTo(map),
          layerLines=L.layerGroup().addTo(map),
          layerSingerLines=L.layerGroup().addTo(map);

    let data={customers:[],leads:[],singer:[],trucks:[],settings:[]};

    function render(){
      layerCustomers.clearLayers(); layerLeads.clearLayers(); layerSinger.clearLayers();
      layerTrucks.clearLayers(); layerLines.clearLayers(); layerSingerLines.clearLayers();

      // Trucks
      data.trucks.forEach(t=>{
        const lat=+ (t.latitude||t.lat||t.lattitude), lng=+ (t.longitude||t.lng||t.longtitude||t.lon);
        if(!isFinite(lat)||!isFinite(lng)) return;
        const col=normHex(t.color)||'#111827';
        L.circleMarker([lat,lng],{radius:7,color:col,weight:2,fillColor:'#fff',fillOpacity:1})
          .bindTooltip(`<div class="text-sm font-bold">${t.truck_id}</div>`,{className:'my',sticky:true})
          .addTo(layerTrucks);
      });

      const cust = data.customers.filter(passFilters);
      const leads = (toggleLeads.checked? data.leads: []).filter(passFilters);
      const singers = (toggleSinger.checked? data.singer: []).filter(passFilters);

      // Customers
      cust.forEach(c=>{
        const lat=+ (c.latitude||c.lat||c.lattitude), lng=+ (c.longitude||c.lng||c.longtitude||c.lon);
        if(!isFinite(lat)||!isFinite(lng)) return;
        const col=getTruckColor(c.truck_id) || '#16a34a';
        const m = L.circleMarker([lat,lng],{ radius:6, color:'#111827', weight:1, fillColor:col, fillOpacity:0.6 })
          .bindTooltip(tooltipHtml(c,'customer'),{className:'my',sticky:true})
          .addTo(layerCustomers);
        m.on('click',()=>{ m.bindPopup(popupHtml(c,'customer'), {autoClose:true, closeOnClick:true, className:'my'}).openPopup(); });
      });

      // Leads + nearest
      const wantNearest = toggleNearest.checked;
      leads.forEach(l=>{
        const lat=+ (l.latitude||l.lat||l.lattitude), lng=+ (l.longitude||l.lng||l.longtitude||l.lon);
        if(!isFinite(lat)||!isFinite(lng)) return;
        const marker = L.marker([lat,lng], { icon: makePinIcon(leadPinColor(l.status)) })
          .bindTooltip(tooltipHtml(l,'lead'), { className:'my', sticky:true })
          .addTo(layerLeads);
        marker.on('click', ()=>{ marker.bindPopup(popupHtml(l,'lead'), {autoClose:true, closeOnClick:true, className:'my'}).openPopup(); });

        if(wantNearest){
          let best={d:Infinity,t:null};
          data.trucks.forEach(t=>{
            const tlat=+(t.latitude||t.lat||t.lattitude), tlng=+(t.longitude||t.lng||t.longtitude||t.lon);
            if(!isFinite(tlat)||!isFinite(tlng)) return;
            const d=haversineKm(lat,lng,tlat,tlng);
            if(d<best.d) best={d,t};
          });
          if(best.t){
            const tlat=+(best.t.latitude||best.t.lat||best.t.lattitude), tlng=+(best.t.longitude||best.t.lng||best.t.longtitude||best.t.lon);
            L.polyline([[lat,lng],[tlat,tlng]],{color:'#64748b',weight:1.5,dashArray:'4 4'}).addTo(layerLines);
          }
        }
      });

      // Singer + nearest
      const wantNearestSinger = toggleNearestSinger.checked;
      singers.forEach(sg=>{
        const lat=+ (sg.latitude||sg.lat||sg.lattitude), lng=+ (sg.longitude||sg.lng||sg.longtitude||sg.lon);
        if(!isFinite(lat)||!isFinite(lng)) return;

        const marker = L.marker([lat,lng], { icon: makeLetterPinIcon('#8B5CF6','S') })
          .bindTooltip(tooltipHtml(sg,'singer'), { className:'my', sticky:true })
          .addTo(layerSinger);
        marker.on('click', ()=>{ marker.bindPopup(popupHtml(sg,'singer'), {autoClose:true, closeOnClick:true, className:'my'}).openPopup(); });

        if(wantNearestSinger){
          let best={d:Infinity,t:null};
          data.trucks.forEach(t=>{
            const tlat=+(t.latitude||t.lat||t.lattitude), tlng=+(t.longitude||t.lng||t.longtitude||t.lon);
            if(!isFinite(tlat)||!isFinite(tlng)) return;
            const d=haversineKm(lat,lng,tlat,tlng);
            if(d<best.d) best={d,t};
          });
          if(best.t){
            const tlat=+(best.t.latitude||best.t.lat||best.t.lattitude), tlng=+(best.t.longitude||best.t.lng||best.t.longtitude||best.t.lon);
            L.polyline([[lat,lng],[tlat,tlng]],{color:'#a78bfa',weight:1.5,dashArray:'4 4'}).addTo(layerSingerLines);
          }
        }
      });

      const all=[]; layerCustomers.eachLayer(l=>all.push(l.getLatLng())); layerLeads.eachLayer(l=>all.push(l.getLatLng())); layerSinger.eachLayer(l=>all.push(l.getLatLng())); layerTrucks.eachLayer(l=>all.push(l.getLatLng()));
      if(all.length) map.fitBounds(L.latLngBounds(all),{padding:[60,60]});
      setSummary({customers:cust,leads,singer:singers});
    }

    async function loadAndRender(){
      try{
        errorBox.classList.add('hidden');
        const [settings, customersRaw, leads, singer, trucks] = await Promise.all([
          fetchSheet(SHEETS.settings),
          fetchSheet(SHEETS.customers),
          fetchSheet(SHEETS.leads),
          fetchSheetOptional(SHEETS.singer),   // ← optional
          fetchSheet(SHEETS.trucks)
        ]);

        const customersData = customersRaw.map(c => ({ ...c, _statusTH: mapStatusTH(c.status) }));

        truckColorMap = {};
        trucks.forEach(t=>{
          const key = normId(t.truck_id);
          const col = normHex(t.color);
          if (key && col) truckColorMap[key] = col;
        });

        data={settings, customers: customersData, leads, singer, trucks};

        const findVal = key => (settings.find(r => (r.key||r.Key||r.setting||'').toString().toUpperCase()===key) || {}).value;
        const cLat = parseFloat(findVal('CENTER_LAT')||16.43),
              cLng = parseFloat(findVal('CENTER_LNG')||103.49),
              zoom = parseInt(findVal('ZOOM')||9);
        map.setView([cLat,cLng], zoom);

        const setOpts=(el,opts)=>{ el.innerHTML=''; el.append(new Option('ทั้งหมด','')); opts.forEach(o=>el.append(new Option(o,o))); };
        setOpts(branchFilter,  uniqueSorted([ ...customersData.map(c=>c.branch), ...leads.map(l=>l.branch), ...singer.map(s=>s.branch) ]));
        setOpts(managerFilter, uniqueSorted([ ...customersData.map(c=>c.manager_incharge), ...trucks.map(t=>t.manager_incharge) ]));
        setOpts(truckFilter,   uniqueSorted(trucks.map(t=>t.truck_id)));

        render();
      }catch(err){ showError(err.message||String(err)); }
    }

    // ---------- Export (filtered) to Excel ----------
    function exportFilteredToExcel(){
      try{
        const filteredCustomers = data.customers.filter(passFilters);
        const filteredLeads    = (toggleLeads.checked ? data.leads  : []).filter(passFilters);
        const filteredSinger   = (toggleSinger.checked ? data.singer : []).filter(passFilters);

        const customerColumns = [
          ['customer_id','Customer ID'], ['customer_name','ชื่อลูกค้า'], ['_statusTH','สถานะลูกค้า (TH)'], ['branch','สาขา'],
          ['truck_id','รหัสรถมิเตอร์'], ['manager_incharge','ผู้จัดการรับผิดชอบ'], ['lastest_sales','ยอดขายล่าสุด'],
          ['notes','หมายเหตุ'], ['latitude','Latitude'], ['longitude','Longitude']
        ];
        const leadColumns = [
          ['leads_name','ชื่อลีด'], ['status','สถานะลีด'], ['branch','สาขา'], ['saler','พนักงานขายผู้ดูแล'],
          ['nearest_truck_id','รถที่ใกล้สุด'], ['province','จังหวัด'], ['district','อำเภอ/เขต'],
          ['notes','หมายเหตุ'], ['latitude','Latitude'], ['longitude','Longitude']
        ];
        const singerColumns = leadColumns; // เหมือน leads

        const mapRows = (rows, columns) => rows.map(r=>{
          const obj={}; columns.forEach(([key,label])=>{
            let v=r[key]; if((key==='latitude'||key==='longitude')&&v!==undefined&&v!==null&&v!==''){const num=parseFloat(v); v=isFinite(num)?+num.toFixed(6):'';}
            obj[label]=(v===undefined||v===null)?'':v;
          }); return obj;
        });

        const wb = XLSX.utils.book_new();
        const wsCustomers = XLSX.utils.json_to_sheet(mapRows(filteredCustomers, customerColumns));
        const wsLeads     = XLSX.utils.json_to_sheet(mapRows(filteredLeads, leadColumns));
        const wsSinger    = XLSX.utils.json_to_sheet(mapRows(filteredSinger, singerColumns));

        const fitCols = (columns) => columns.map(([,label])=>({ wch: Math.max(12, label.length + 4) }));
        wsCustomers['!cols']=fitCols(customerColumns); wsLeads['!cols']=fitCols(leadColumns); wsSinger['!cols']=fitCols(singerColumns);

        XLSX.utils.book_append_sheet(wb, wsCustomers, 'Customers (filtered)');
        XLSX.utils.book_append_sheet(wb, wsLeads, 'Leads (filtered)');
        XLSX.utils.book_append_sheet(wb, wsSinger, 'Singer (filtered)');

        const b=branchFilter.value || 'All', m=managerFilter.value || 'All', t=truckFilter.value || 'All', s=statusFilter.value || 'All';
        const dateStr = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        const filename = `KCP-Export_${dateStr}_B-${b}_M-${m}_T-${t}_S-${s}.xlsx`.replace(/[\\/:*?"<>|]+/g,'-');
        XLSX.writeFile(wb, filename);
      }catch(err){ showError('ไม่สามารถส่งออกเป็น Excel ได้: ' + (err.message || String(err))); }
    }

    // UI bindings
    btnRefresh.onclick = ()=>loadAndRender(true);
    btnReset.onclick = ()=>{ [branchFilter,managerFilter,truckFilter,statusFilter].forEach(el=>el.value=""); render(); };
    [branchFilter,managerFilter,truckFilter,statusFilter,toggleLeads,toggleNearest,toggleSinger,toggleNearestSinger].forEach(el=> el.addEventListener('change',render));
    btnExport.onclick = exportFilteredToExcel;

    // refs
    const sumCustomers=document.getElementById('sumCustomers');
    const sumLeads=document.getElementById('sumLeads');
    const sumSinger=document.getElementById('sumSinger');
    const sumActive=document.getElementById('sumActive');
    const sumRisky=document.getElementById('sumRisky');
    const sumLost=document.getElementById('sumLost');
    const errorBox=document.getElementById('errorBox');

    const branchFilter=document.getElementById('branchFilter');
    const managerFilter=document.getElementById('managerFilter');
    const truckFilter=document.getElementById('truckFilter');
    const statusFilter=document.getElementById('statusFilter');
    const toggleLeads=document.getElementById('toggleLeads');
    const toggleNearest=document.getElementById('toggleNearest');
    const toggleSinger=document.getElementById('toggleSinger');
    const toggleNearestSinger=document.getElementById('toggleNearestSinger');

    loadAndRender();
    setInterval(loadAndRender,300000);
  </script>
</body>
</html>
